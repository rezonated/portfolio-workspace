{{ $id := .Get "id" }}
{{ $scene := .Get "scene" }}

{{/* Determine if the scene uses a 2D HTML layout or a 3D WebGL layout */}}
{{ $is2D := or (eq $scene "memory-layout") (eq $scene "parallelization") (eq $scene "double-buffer") }}
{{ $isDouble3D := or (eq $scene "ism-rendering") }}

<div class="diagram-wrapper" style="margin-bottom: 1.5rem; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; background-color: #f0f0f0;">

    {{ if $is2D }}
        <div id="{{ $id }}-container" class="html-diagram-container" style="position: relative; {{ if or (eq $scene "memory-layout") (eq $scene "double-buffer") }} min-height: 450px; {{ end }}"></div>
    {{ else if $isDouble3D }}
         <div class="threejs-double-container" style="display: flex; flex-direction: row;">
            <div id="{{ $id }}-left" style="width: 50%; height: 450px; position: relative; border-right: 1px solid #ddd;"></div>
            <div id="{{ $id }}-right" style="width: 50%; height: 450px; position: relative;"></div>
        </div>
    {{ else }}
        <div id="{{ $id }}" style="position: relative; width: 100%; height: 450px;">
            <div id="{{ $id }}-ui" style="position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); border-radius: 5px; padding: 8px; font-family: sans-serif; font-size: 12px; display: none; z-index: 10;">
                <p style="margin: 0 0 5px 0; font-weight: bold;">Controls:</p>
                <div id="{{ $id }}-controls"></div>
                <p id="{{ $id }}-help-text" style="margin: 10px 0 5px 0; font-size: 11px; color: #555;"></p>
            </div>
            <div id="{{ $id }}-overlay" style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; padding: 5px 10px; border-radius: 3px; font-family: monospace; font-size: 14px; display: none; z-index: 10;"></div>
        </div>
    {{ end }}

</div>

<script type="module">
    if ('{{ $scene }}' === 'memory-layout') {
        const { initMemoryLayoutScene2D } = await import('{{ "/js/boids-visualizer.js" | relURL }}');
        initMemoryLayoutScene2D(document.getElementById('{{ $id }}-container'));
    } else if ('{{ $scene }}' === 'parallelization') {
        const { initParallelismScene } = await import('{{ "/js/boids-visualizer.js" | relURL }}');
        initParallelismScene(document.getElementById('{{ $id }}-container'));
    } else if ('{{ $scene }}' === 'double-buffer') {
        const { initDoubleBufferScene } = await import('{{ "/js/boids-visualizer.js" | relURL }}');
        initDoubleBufferScene(document.getElementById('{{ $id }}-container'));
    } else if ('{{ $scene }}' === 'ism-rendering') {
        const { initIsmScene } = await import('{{ "/js/boids-visualizer.js" | relURL }}');
        const left = document.getElementById('{{ $id }}-left');
        const right = document.getElementById('{{ $id }}-right');
        initIsmScene(left, right);
    } else {
        const { initScene } = await import('{{ "/js/boids-visualizer.js" | relURL }}');
        const container = document.getElementById('{{ $id }}');
        const uiPanel = document.getElementById('{{ $id }}-ui');
        const controlsContainer = document.getElementById('{{ $id }}-controls');
        const helpText = document.getElementById('{{ $id }}-help-text');
        const overlay = document.getElementById('{{ $id }}-overlay');
        initScene(container, '{{ $scene }}', { uiPanel, controlsContainer, helpText, overlay });
    }
</script>